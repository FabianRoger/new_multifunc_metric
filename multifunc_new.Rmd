---
title: "A New Multifunc"
date: "`r format(Sys.time(), '%d %B, %Y')`" 
output: 
    html_document:
    keep_md: yes
---
```{r libraries, include=FALSE, message=FALSE, warning=FALSE}
library(multifunc)
library(tidyverse)
library(ggplot2)
library(viridis)
library(gridExtra)
```

#### Introduction

The past decade has witnessed the growth of the concept of ecosystem **multifunctionality**. Multifunctionality is defined as a measure of the simultaneous performance of multiple functions. Note that we do not say "ecosystem functions", as multifunctionality is a broader concept that can be easily applied outside of community and ecosystem ecology - and even outside of ecology altogether. This concept has proven unifying in a number of different situations. In the Biodiversity Ecosystem Function literature, it has enabled researchers to discover new mechanisms by which diversity is altering the function of ecosystems [*can we be more specific here*]. Researchers are beginning to recognize that foundation species create multifunctional landscapes (Angelini et al. DATE) that differ not only in species diversity and abundance, but ecosystem-level properties. Invasion biology has begun to use multifunctionality to quantify whole-system level changes (Ramus et al. PNAS). Multifunctionality has tremendous application as well, as managers often attempt to work towards the provision of multiple ecosystem services (REFS) - fundamentally the same concept as multifunctionality - or see single ecosystem services as the product of multiple different ecosystem functions (Frontiers REF) [*I'm not sure I get this at the moment - but haven't read the paper*]. 

However, adoption of multifunctionality as a fundamental concept linking community and ecosystem ecology has been slow [*can we hint at the potential for that link before this sentence?*]. Nor is there a robust theoretical core behind multifunctionality, further hindering its penetration into scientific thinking. We posit that there is at least one simple explanation behind this lack of progress. While some researchers and managers have latched on to the concept of multifunctionality, the field still lacks a clear single metric that it can use to summarize the phenomenon. Frankly, current metrics range from the simple yet misstated to the complex and accurate yet unweildy. We acknowledge some of our own blame in this state of affairs (Byrnes et al. 2014); although we do note that throwing even some of the finest minds against this problem in a stimulating working group format over multiple years (we are thankful for NCEAS) has likely resulted in more ink impregnated on foreheads hitting whiteboards than should be typical. We are similarly thankful that many in the field have continued to be critical and force us to look at our current failures with honesty (Fabian's paper).

Here we briefly review the current state of affairs, propose a solution, and discuss some of the ongoing challenges to the field, including whole conceptual fields of exploration that we feel have been entirely missed.

#### The current state of multifunctional affairs

The definition of multifunctionality presents a challenge. How to we define a metric that captures both the level of performance of a broad suite of functions as well as the distribution of differences in performance between functions? Researchers have sought to capture this question in four ways, after standardizing functions to similar levels in order to prevent apples-to-oranges comparisons.

First, on the side of simplicty, taking the average of all functions [REFS]. This approach appears on its face appealing, particularly as it provides a metric that can be put on a y-axis while a predictor is on the x. However, it sacrifices crucial information about the system. An arithmetic mean tells us, were we to sample any one function, what level of functioning would we expect? Consider two plots - one where all functions are similar and performing at half their value and one where half of the functions are at their maximum while half are absent. The averaging approach says that they are identical. Geometric averaging appears to get around this problem to some degree, as a geometric mean is approximately the arithmetic mean minus the variance of observations. However, given its formulation, one critically low function can bias the measurement, nor do we always have a sufficient sample of functions to achieve that approximation.

Second, we have metrics of the Multivariate Diversity Interactions framework (Dooley et al. 2015). This elegant framework allows us to tease apart the importance of correlations between functions and the contribution of different drivers to simultaneous change in those functions. It does not, however, provide a holistic metric of multifunctionality *per se*, much like the overlap approach before it [*which it is really a generalization of*]. While we gain rich information about a system, we do not gain holistic interpretability.

Last, we have the multiple threshold approach. This approach seeks to balance the goals of measuring the simultaneous performance of multiple ecosystem functions with the arbitrariness of choosing a threshold of relevance for those functions. We note that many who use it simply choose a single threshold, although present many in their appendicies (e.g., SOMEONE). This is a reasonable choice in order to understand a single set of observations. Further, for those who do look at all thresholds, the results are, frankly, difficult to interpret as the quantities they yeild are non-obvious in their links to the concept of multifunctionality. The approach yields rich information about multifunctionality *sensu stricto*, but in so doing, becomes unweildy for most if not all who choose to use it.

How can we solve this? What is a good metric of multifunctionality that yields the information we need in a proper holistic fashion such that we might even ultimately link it back to theory?

#### A Way Forward

The definition of multifunctionality presents a challenge. How do we define a metric that captures both the level of performance of a broad suite of functions as well as the distribution of differences in performance between functions? This problem seems akin to the problem of capturing diversity of species within a community. We know the "richness" of functions - it is the total number of functions we are observing. This richness can be partitioned independently into evenness and a measure of compositional complexity (Jost 2010). In the diversity literature, this metric of complexity can be simply translated into an effective number of species, i.e., the number of equally abundant species that would produce the same metric (Jost 2006, 2010), via Hill Numbers. This concept of effective number of functions is equally powerful in the context of measuring multifunctionality. For some set of functions that have been standardized to a common scale (i.e., between 0 and 1) such that $F_{1,2,3...S}$ is their level of function

$$p_i = \frac{F_i}{\sum F_i}$$

$$^{q}N = (\sum_{i=1}^{S}p_{i}^q)^{1/(1-q)}$$

where $N_q$ is the effective number of functions for some order q. Adapting from Jost (2006), if q = 0, this is the total number of functions, S. If q<1, then functions at low level dominate the calculation. For q = 1, the approximation of this function is equivalent to results from Shannon diversity for species. For q>1, higher functions are given greater weight. At q = 2, we get results that are equivalent to the equivalent number of functions calculated from Simpson's diversity. If one of our goals is to up-weight high performing functions, q=2 is a reasonable choice. However, to be conservative, q=1 is sufficient.

At this point, we can calculate evenness as this effective number of functions divided by the number of functions divided we are observing (Jost 2010). 

$$E = \frac{^{q}N}{S}$$

Armed with functional evenness, effective number of functions, and average level of function, here defined as $A$, we can turn to creating a meaningful multifunctionality metric based on evenness. 
[*at some stage before here, I think it would be worth making it clear that we need to account for $A$ because unlike diversity, the equivalent of community size (the sum of functions) is of interest*]

$$M_e = E A$$

This metric can also be rescaled back to units of number of functions by multiplying it by total number of functions providing an metric on the scale of the absolute number of functions, such that $M_f = M_e S$.

Why must we consider level of function and evenness together in one metric?  From a convenience standpoint, a combined metric satisfies our definition of multfunctionality. More importantly, both metrics are non-independent (Figure 1A). Consider, for example, that it is not possible to have a patch where all functions are at their maximum, but is anything less than completely even. Similarly, a patch whose functions are maximally "even" - or all doing something different from one another - cannot by definition have the highest levels of average function. Indeed, if functional evenness is < 1, then by definition the average is bound to be less that 1. The lowest evenness possible is 1/S. We can visualize this in phase space as well (Figure 1b).

**yeah, the linear case below works for q=2, but I need to see if there's a more general expression here. consider this a starting point**

[*I made a comment on the multifunc github repo - seems like one of the functions is hardwired to use an object called "duffy" from the code chunk below - that causes the compiliation to crash*]

```{r show_conceptual, echo=FALSE, cache=TRUE, fig.width=10}
#' Function to make data of all combinations
#' of different levels of function, ranging from 
#' 0 to 1 with a user defined step size
make_data <- function(n=3, minVal = 0.01, ...){
  amat <- as.tibble(matrix(rep(seq(minVal,1,...),n), ncol=n))
  amat %>% expand.grid %>% as.tibble
}

fun_df <- make_data(n = 4, length.out=10) %>%
  mutate(mf_a = rowMeans(.),
         mf_even = even_fact(.))


sim_plot <- ggplot(fun_df) +
  theme_bw(base_size=14) +
  aes(x=mf_a, y=mf_even, color=mf_a*mf_even) +
  geom_point() +
  geom_hline(yintercept=0.5, col="red", lty=2)+
  geom_vline(xintercept=0.5, col="red", lty=2) +
  scale_color_viridis(begin=0.3, option="B",
                     guide=guide_colorbar("Multifunctionality")) +
  xlab("Average Level of Functioning") +
  ylab("Evenness of Functioning") +
  ylim(c(0,1)) +
  xlim(c(0,1))
  

concep_df <- crossing(mf_a=seq(0,1,length.out=400), 
                      mf_e=seq(0,1,length.out=400)) %>%
  filter(mf_e>=mf_a) %>%
  filter(mf_e >=1/10)%>%
  mutate(mf = mf_e * mf_a)

concep_plot <- ggplot(concep_df, aes(x=mf_a, y=mf_e, fill=mf)) +
  geom_raster(interpolate=TRUE) +
  scale_fill_viridis(begin=0.3, option="B",
                     guide=guide_colorbar("Multifunctionality"))+
  scale_x_continuous(breaks = c(0, 1/10, 0.5, 1),
                     labels = c(0, "1/S", 0.5, 1),
                     lim=c(0,1), minor_breaks = NULL) +
  scale_y_continuous(breaks = c(0, 1/10, 0.5, 1),
                     labels = c(0, "1/S", 0.5, 1),
                     lim=c(0,1), minor_breaks = NULL) +
  geom_hline(yintercept=0.5, col="black", lty=2)+
  geom_vline(xintercept=0.5, col="black", lty=2) +
  theme_bw() +
  xlab("Average Level of Functioning") +
  ylab("Evenness of Functioning")

grid.arrange(sim_plot, concep_plot, ncol=2)
```

Further, having this single metric now allows us to begin to examine it as any other response variable. In the BEF world, we might look at additive partioning in addition to complementary overlap approaches. In global change biology, we can look at stability, resistance, and resilience. The options are open.

#### Application to real data

To see how this metric can be used, consider the example of Duffy et al. 2003. In this experiment, Duffy and colleagues sought to examine how biodiversity of grazers influences multiple different ecosystem functions in seagrass ecosystems. Using the functions discussed in the paper, we standardized and reflected them as per how Duffy et al. discuss their results. Comparing  M<sub>e</sub>, average functional performance, and functional evenness (Figure 2).

```{r duffy, echo=FALSE}
data("duffy_2003")

duffyAllVars <- qw(grazer_mass,wkall_chla,tot_algae_mass,
                  Zost_final_mass,sessile_invert_mass,sediment_C)

duffyAllVars.std <- paste0(duffyAllVars, ".std")
#re-normalize so that everything is on the same 
#sign-scale (e.g. the maximum level of a function is the "best" function)
#and the dataset is cleaner
duffy <- duffy_2003 %>%
 dplyr::select(treatment, diversity, one_of(duffyAllVars)) %>%
 dplyr::mutate(wkall_chla = -1*wkall_chla + max(wkall_chla, na.rm=T),
               tot_algae_mass = -1*tot_algae_mass + max(tot_algae_mass, na.rm=T)) 

#first, mean multifunctionality
duffy <- duffy %>%
 cbind(getStdAndMeanFunctions(duffy, duffyAllVars)) %>%
 dplyr::rename(`Average Function` = meanFunction, Richness=diversity)

#now evenness
duffy[["Functional Evenness"]] <- duffy %>% funcEven(duffyAllVars.std)

#Now our multifunctionality metric - I could have
#done this as a product, but I'm guessing people will want a function
duffy$Multifunctionality <- duffy %>% getMF(duffyAllVars)

duffy_for_plotting <- duffy %>%
 select(Richness, treatment, 
        `Average Function`, `Functional Evenness`, Multifunctionality) %>%
 gather(index, value, -Richness, -treatment)

ggplot(duffy_for_plotting,
      aes(x=Richness, y=value)) +
 facet_wrap(~index) +
 geom_point() +
 theme_bw(base_size=17) +
 stat_smooth(method="lm", color="black") +
  ylab("Value")
```

What is intriguing about this is that across the experiment, functional evenness remained high. However, when combined with average function, the slope appears slightly steeper than either of the two relationships - diversity's importance might well be gerater. Part of this might be driven by the positive correlation between the two variables given their functional constraint (Figure 3). [*I wonder if it would be helpful to provide the slopes of these relationships in the text - the reason I suggest that is because it is not immediately apparent from the figure that the 3rd panel has a steeper slope than the first 2, but that is part of the attraction of the method is that it combines both the effect on average function and on evenness*]

```{r duffy_trdeoff, echo=FALSE}
ggplot(duffy,
       aes(`Average Function`, `Functional Evenness`, color=factor(Richness))) +
  geom_point() +
  theme_bw() +
  ylim(c(0,1)) +
  xlim(c(0,1))
```

Regardless, our results broadly reproduce the qualitative conclusions of Duffy et al. (2003) but with additional clarity, as they do for biodepth as well (SUPPLEMENT).
[*so, do we want to include biodepth in the supplement or in the main text - it makes the paper seem beefier if we analyse both data sets in text - however, we can decide later*]

#### Robutness of metric
# FABIAN DO MAGIC HERE

#### A note on correlated functions

A great deal of the confusion in the multifunctionality literature even when using metrics has sprung from the issue of correlation between functions (BACK AND FORTH IN PNAS). In no small part this is likely due to the incessant focus on accounting for correlation in areas such as spatial and temporal analysis. To have correlations between functions seems to somehow either "contaminate" results and make them suspect or, for others, only correlated functions are valid to indicate multifunctionality (PNAS ref). Neither of these are strictly true. 

The difficulty comes down to defining just what a 'function' is. This semantic argument has led down the path of considering "true" functions as the single response to a driver that gives rise to all other responses. Consider the example of aboveground and belowground production in plants. The two are driven by similar, if not mutually overlapping, biological processes. Thus, are they truly separate functions? If biological reductionism in functional space is the goal of a researcher, then dimensional reduction techniques before analysis would seem to be in order. We offer a caution, however, that techniques such as PCA reduce dimensions with absolutely no basis in biology. Rather, Confirmatory Factor Analysis (ref) with a meaningful underlying factor structure might provide a far more useful and biologically meaningful option.

On the other hand, when we consider an ecosystem function as a measurement of some flux within an ecosystem, the issue of correlation becomes moot. Was there a flux, or was there not a flux? Was that flux uniquely relevant to some other ecosystem processes? Root microbes care not for larger leaves. Similarly, managers have goals that focus on functions and services that are independent of any biological reductionism. Hence, sweeping this correlation under the rug for a single metric of multifunction is not only acceptable, but desirable in terms of defining a clear metric of the concept. If researchers are interested in exploring the correlation structure of functions - or even how that structure changes across treatments (something to our knowledge that has not been done) - then that is a separate piece of a good ecological story. It does not, however, invalidate any metric of multifunctionality seeking to capture simultaneous change in multiple functions. It comes down to a researchers question and how that question forces them to define functions. This is an epistomological point beyond the scope of any metric.

[*so my two cents here - I think you are right that this is a topic beyond metrics. However, at some level, multifunctionality is intrinsicly related to the correlation among functions. If all functions are correlated with each other, than increasing one means increasing them all - therefore, you have a highly multifunctional system. If you have an a priori definition of which functions you are interested in, then perhaps it doesn't matter. However, I think it is worth bearing in mind that when we ask if some covariate (e.g. diversity) increases multifunctionality, we are in effect asking if (a) the average effect is increasing and (b) whether the correlation among functions is increasing - the latter is similar to the evenness part of the index. Writing this, I wonder if it is possible to unravel the connection between evenness and correlation*]

#### Thinking Beyond Measured Functions

One potential pitfall of this technique is to assume that it is robust to a researchers choice in what functions to measure in terms of the inferences it can deliver about a system. In an ideal world, when we quantify multifunctionality we would think of all possible functions as a population. We would then measure a random (or stratified!) sample of functions in order to draw good inferences about how a driver influences system-wide multifunctionality. To our knowledge, this type of careful thought about relevant functions from a population sampling perspective has never been applied in multifunctionality research. We hope we are wrong about this, and applaud anyone who has done so. Recently, several excellent guides to standardized measuring of relevant ecosystem functions have begun to appear in the literature (TWO TREE PAPERS). We suggest these as a starting point for any researchers interested in thinking carefully about the topic, in addition to fruitful discussions of with ecosystem ecologists working in the same system. They are highly likely to disabuse any community ecologist of the notion that they have fully captures a good sample of the population of relevant functions, and provide guidance on further ways to do so (J. Bowen, pers. com.).

#### Conclusions

We hope that this piece will provide the field of multifunctionality with a way out of its current state of division and confusion. Further, we hope it provides food for additional theory that addresses the causes and consequences of ecosystem multifunctionality, something that is currently sorely lacking. We have been heartened by the idea leaving the cradle of the field of biodiversity and ecosystem function, and feel that it has the promise to provide a holistic unifying concept for anyone interested in capturing a snapshot of system dynamics in single meaningful metric.